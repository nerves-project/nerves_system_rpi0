language: erlang
otp_release:
  - 19.0

# It would be possible to use the container-based infrastructure if
# it ran trusty. However, it doesn't and wget is too old to use for
# HTTPS to buildroot.net.
sudo: required
dist: trusty

# Install dependencies
addons:
  apt:
    packages:
    - bc
    - libssl-dev

notifications:
  webhooks:
    urls:
      - $GITTER_WEBHOOK_URL
    on_success: change  # options: [always|never|change] default: always
    on_failure: always  # options: [always|never|change] default: always
    on_start: never     # options: [always|never|change] default: always

# Cache downloaded files between builds
cache:
    directories:
      - $HOME/.nerves/cache/buildroot

env:
  - NERVES_TARGET=rpi CI_SYSTEM_NAME=nerves_system_$NERVES_TARGET REPO=nerves-project/$CI_SYSTEM_NAME NERVES_SYSTEM_CACHE=none NERVES_SYSTEM_COMPILER=local

before_install:
  - git clone https://github.com/elixir-lang/elixir
  - cd elixir
  - git checkout v1.3
  - make clean
  - make
  - cd ..

before_script:
  - export PATH=`pwd`/elixir/bin:$PATH

script:
  - mix local.hex --force
  - mix local.rebar --force
  - mix deps.get
  - mix archive.install https://github.com/nerves-project/archives/raw/master/nerves_bootstrap.ez --force
  - mix compile
  - export NERVES_PACKAGE=`pwd`
  - export NERVES_SYSTEM=`pwd`/_build/dev/nerves/system
  - export NERVES_TOOLCHAIN=`pwd`/_build/dev/nerves/toolchain
  - git clone https://github.com/nerves-project/nerves-examples
  - cd nerves-examples/hello_gpio
  - export MIX_ENV=travis
  - mix deps.get
  - mix compile
  - mix firmware

# Deploy the build products
before_deploy:
    - mix compress.nerves_system
    - deps/nerves_system_br/scripts/ci-deploy.sh

deploy:
  # Deploy tagged releases to GitHub
  - provider: releases
    api_key: $GITHUB_API_KEY
    file:
      - "artifacts/$CI_SYSTEM_NAME-$TRAVIS_TAG.tar.gz"
      - "artifacts/$CI_SYSTEM_NAME-$TRAVIS_TAG.fw"
    skip_cleanup: true
    overwrite: true
    on:
      repo: $REPO
      tags: true

# Display build log on failure
after_failure:
    - tail -n 1000 build.log
